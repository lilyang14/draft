<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>作品集</title>

  <!-- favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="favicon_io/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon_io/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon_io/favicon-16x16.png">
  <link rel="manifest" href="favicon_io/site.webmanifest">
  <meta name="theme-color" content="#1C1C1C">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background:#1C1C1C;
      color:white;
      font-family:-apple-system,PingFang SC,Helvetica,Arial;
    }

    .page { padding-top:60px; display:flex; justify-content:center; }
    .gallery { width:100%; max-width:min(1200px,65vw); }

    .gallery-item { width:100%; margin:0; position:relative; overflow:hidden; }
    .gallery-item img {
      width:100%; height:auto;
      object-fit:fill;
      user-select:none; pointer-events:none;
    }

    .skeleton{
      width:100%; height:1080px;
      background:rgba(255,255,255,0.20);
    }

    /* 网络异常 */
    .offline-overlay{
      position:fixed; inset:0;
      display:none; justify-content:center; align-items:center;
      background:rgba(0,0,0,0.6); z-index:9999;
    }
    .offline-sheet{ text-align:center; }
    .offline-sheet p{ margin-bottom:20px; }

    .reload-btn{
      width:96px; height:36px;
      font-size:14px; color:white;
      background:rgba(255,255,255,0.2);
      border:none; border-radius:4px;
      cursor:pointer;
    }

    @media(max-width:800px){
      .gallery{ max-width:100%; }
    }
  </style>
</head>
<body>
  <div class="page">
    <main class="gallery" id="gallery"></main>
  </div>

  <!-- 网络异常 -->
  <div class="offline-overlay" id="offline">
    <div class="offline-sheet">
      <p>网络异常，请重新加载</p>
      <button class="reload-btn" id="reloadBtn">重新加载</button>
    </div>
  </div>

  <script>
    window.scrollTo(0,0);

    // 禁止右键保存
    document.addEventListener("contextmenu", e => {
      if (e.target.tagName === "IMG") e.preventDefault();
    });

    const offlineUI = document.getElementById("offline");
    const reloadBtn = document.getElementById("reloadBtn");
    reloadBtn.onclick = () => location.reload();

    function checkNetwork(){
      offlineUI.style.display = navigator.onLine ? "none" : "flex";
    }
    window.addEventListener("online",checkNetwork);
    window.addEventListener("offline",checkNetwork);
    checkNetwork();

    /** 关键优化：并行检测 + 并行加载 **/
    const gallery = document.getElementById("gallery");

    async function checkExist(url){
      try{
        const res = await fetch(url, {method:"HEAD"});
        return res.ok;
      }catch(e){
        return false;
      }
    }

    async function loadAll(){
      const tasks = [];
      const maxCheck = 100; // 可自由扩容

      // 并行检查 work1.png ~ work100.png
      for(let i=1;i<=maxCheck;i++){
        const url = `images/work${i}.png`;
        tasks.push(checkExist(url).then(ok => ({i, ok, url})));
      }

      const results = await Promise.all(tasks);

      // 过滤存在的图片，按序排列
      const files = results.filter(r=>r.ok).sort((a,b)=>a.i-b.i);

      if(files.length===0){
        gallery.innerHTML = `<p style="color:#fff;padding:40px;text-align:center;">images 文件夹没有找到 workX.png</p>`;
        return;
      }

      // 一次性渲染 skeleton
      files.forEach(file=>{
        const item = document.createElement("div");
        item.className = "gallery-item";

        const skeleton = document.createElement("div");
        skeleton.className = "skeleton";

        item.appendChild(skeleton);
        gallery.appendChild(item);

        // 图片并行加载
        const img = new Image();
        img.src = file.url;
        img.loading = "lazy";
        img.decoding = "async";
        img.draggable = false;

        img.onload = () =>{
          skeleton.replaceWith(img);
        };
        img.onerror = () =>{
          skeleton.style.background = "rgba(255,0,0,0.2)";
          skeleton.textContent = "加载失败";
          skeleton.style.color="white";
          skeleton.style.display="flex";
          skeleton.style.alignItems="center";
          skeleton.style.justifyContent="center";
        };
      });
    }

    loadAll();
  </script>
</body>
</html>
